#!/bin/sh
#===============================================================================
#
#  trustfence-initramfs-init
#
#  Copyright (C) 2016, 2017 by Digi International Inc.
#  All rights reserved.
#
#  This program is free software; you can redistribute it and/or modify it
#  under the terms of the GNU General Public License version 2 as published by
#  the Free Software Foundation.
#
#
#  !Description: Init script for Trustfence initramfs
#
#===============================================================================

POWEROFF_TIME="10"

error() {
	[ "${#}" != "0" ] && printf "\n[ERROR]: %s\n\n" "${1}"
	echo "The system will poweroff in ${POWEROFF_TIME} seconds"
	sleep "${POWEROFF_TIME}"
	sync && poweroff -f
}

#------------------------------------------------------------------------------
# Function - get_kernel_version
#
# Obtain the kernel version and return it in number format
#
# @return  - kernel version
#------------------------------------------------------------------------------
get_kernel_version() {
	major="$(uname -r | cut -d'.' -f1)"
	minor="$(uname -r | cut -d'.' -f2)"
	echo $(((major << 8) + minor))
}

# Main
#------------------------------------------------------------------------------
# Setup the environment.
export PATH=/bin:/sbin:/usr/bin:/usr/sbin

mkdir -p /proc /sys /dev
mount -t proc proc /proc
mount -t sysfs sysfs /sys
mount -t devtmpfs devtmpfs /dev

# Set kernel console loglevel
LOGLEVEL="$(sysctl -n kernel.printk)"
sysctl -q -w kernel.printk=4

# Launch 'rngd' to feed random data to kernel entropy pool
# for kernels previous to v3.17
if [ "$(get_kernel_version)" -lt "$(((3 << 8) + 17))" ]; then
	mkdir -p /var/run && rngd
fi

for arg in $(cat /proc/cmdline); do
	case "${arg}" in
		init=*|rescue=1|root=*) eval ${arg};;
	esac
done

# Translate "PARTUUID=..." to real device
root="$(findfs ${root})"

# Jump to a rescue shell if requested
if [ -n "${rescue}" ]; then
	# Expand console and respawn if exited
	while true; do
		setsid cttyhack sh -l
		sleep 1
	done
fi

# Open LUKS encrypted device
if trustfence-tool ${root} cryptroot; then
	# Reset root variable to the decrypted mapped device
	root="/dev/mapper/cryptroot"
else
	error "unable to open encrypted partition."
fi

# Mount mapped device
mkdir -p /newroot
FSTYPE="$(blkid ${root} | sed -e 's,.*TYPE="\([^"]\+\)".*,\1,g')"
mount ${FSTYPE:+-t ${FSTYPE}} ${root} /newroot

#
# Clean-up and do the switch_root to the final rootfs
#
# - explicit kill 'rngd' daemon so it doesn't leak to the final rootfs
# - restore previous kernel console loglevel
# - umount virtual filesystems
#
if [ "$(get_kernel_version)" -lt "$(((3 << 8) + 17))" ]; then
    pkill -9 rngd
fi
[ -n "${LOGLEVEL}" ] && sysctl -q -w kernel.printk="${LOGLEVEL}"
mount --move /dev /newroot/dev
umount /sys /proc
exec switch_root /newroot ${init:-/sbin/init}
